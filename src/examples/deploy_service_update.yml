description: |
  Update an ECS service using OIDC for authentication.
  Import the aws-cli orb and authenticate using the aws-cli/setup command with a valid role_arn for OIDC authentication.
usage:
  version: 2.1
  orbs:
    aws-ecr: circleci/aws-ecr@9.0
    aws-ecs: circleci/aws-ecs@4.0
    # Importing aws-cli orb is required for authentication
    aws-cli: circleci/aws-cli@4.0
  workflows:
    build-and-deploy:
      jobs:
        - aws-ecr/build-and-push-image:
            auth:
              # Add authentication step with OIDC using aws-cli/setup command
              - aws-cli/setup:
                  profile: "OIDC-USER"
                  role_arn: "arn:aws:iam::123456789012:role/VALID_OIDC_ECR_ROLE"
            # Must use same profile configured in aws-cli/setup command
            profile: "OIDC-USER"
            registry-id: AWS_ECR_REGISTRY_ID
            repo: '${MY_APP_PREFIX}'
            region: AWS_REGION
            tag: '${CIRCLE_SHA1}'
        - aws-ecs/deploy_service_update:
            auth:
              # Add authentication step with OIDC using aws-cli/setup command
              - aws-cli/setup:
                  profile: "OIDC-USER"
                  role_arn: "arn:aws:iam::123456789012:role/VALID_OIDC_ECS_ROLE"
            # Must use same profile configured in aws-cli/setup command
            profile: "OIDC-USER"
            requires:
              - aws-ecr/build-and-push-image
            family: '${MY_APP_PREFIX}-service'
            cluster: '${MY_APP_PREFIX}-cluster'
            container_image_name_updates: 'container=${MY_APP_PREFIX}-service,tag=${CIRCLE_SHA1}'
