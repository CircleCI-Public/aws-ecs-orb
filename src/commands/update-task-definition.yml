description: >
  Registers a task definition based on the last task definition, except
  with the Docker image/tag names and environment variables of the containers updated
  according to this command's parameters.

parameters:
  container-env-var-updates:
    default: ''
    description: >
      Use this to update or set the values of environment variables that
      will be defined for the containers.
      (Existing environment variables not included in this parameter will not be removed)
      Expected format: container=<container-name>,name=<env-var-name>,value=<env-var-value>,container=...,name=...,value=...,
      Values should not contain commas.
    type: string
  container-image-name-updates:
    default: ''
    description: >
      Use this to update the Docker image names and/or tag names of existing
      containers that had been defined in the previous task definition.
      Expected format: container=<container-name>,image-and-tag=<image-name>:<tag-name>|image=<image-name>|tag=<tag-name>,container=...,image-and-tag|image|tag=...,
      For each container, specify only either "image-and-tag" or "image" or "tag".
      If "image-and-tag" is specified, the container image will be updated to the
      value of the name-value pair.
      If "image" is specified, the image tag defined in the previous task definition
      will be retained, if exists.
      If "tag" is specified, the image name defined in the previous task definition
      will be used.
    type: string
  family:
    description: Name of the task definition's family.
    type: string
steps:
- run:
    command: <<include(scripts/prep-task-definition.sh)>>
    name: Retrieve previous task definition and prepare new task definition values
- run:
    command: <<include(scripts/register-task-definition.sh)>>
    name: Register new task definition
